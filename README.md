## VERCEL
La parte front del proyecto se ha desplegado en Vercel con el siguiente enlace:
https://trazabilidad-aceite-pfm.vercel.app/

**Repositorio copia para despliegues**
Enlace al repositorio de despliegues de Vercel:
https://github.com/JoakiDev/trazabilidad-aceite-pfm

## Extension para drawio

code --install-extension hediet.vscode-drawio

## Mnemonic

**Frase mnemonic**

Phrase:
half crop demise hello canoe rebel figure flock turkey day elephant wheat

## Cuentas

**Cuentas para pruebas JOAQUIN**

Accounts:
- Admin:
Address:     0x9f35aD88884808d40F5321Ea48A29F974F0EF249
Private key: 0x8daf83c362d3908d27231f7e6f43a79c959903f137d9f39b1ddf4352533dab1a

- Productor 1:
Address:     0xD3b341D0faDe31D58c7106c0a3C3D901E21F58f4
Private key: 0x60a5c588f8c4061242b5888f3d6ea74f2332f20467f6dec05c3e3bf78542d717

- Productor 2:
Address:     0x0033cF9F585Bfe822359fa1F11f65fbc0e1E8182
Private key: 0xbf0ab140a1e2e7b7f7f997c13fd22254997101168b7d491035581ce3875d8aee

- Productor 3:
Address:     0x925C9694853a7aF711E6512dA0A87Ba529dF4986
Private key: 0xf0a58255d73c9e085b19a13f7f1ff5dfec63a42279adfefbab5bd550d963eb8c

- Fabrica 1:
Address:     0x3BfbC9dc781DC464166590f9855B78eC483ddC5E
Private key: 0x53d947d87251115f90ce6aee77377c9b3e5528fdf8ecf3e7050ab93de11a2603

- Fabrica 2:
Address:     0x1Ff3B17D050909fF1a9Af95A1950CE11cEc9148A
Private key: 0xcc480c8d493ba4331fee051134bbe3f845122e94590b7d51853f7cf02e617c60

- Minorista 1:
Address:     0xb03C8cdd9aD635242700453D2e75Ce6d8E52ffD4
Private key: 0x40fd79837d4353fa971fa0e042315c9a24ffe57671a673b9b9f34393fefdbfc9

- Minorista 2:
Address:     0xA6C4eC6a8D42aE2c5DE9cEA1E9700C2937a4929d
Private key: 0x47ec3c74761514f1ca657dfec0fd33462f9ed822fa89144d857132b6632d88cf

- Consumidor 1:
Address:     0x9aa9E44E3D72e78B0De60F4BFDb20231207ad3ca
Private key: 0x33aed039717cecdcf4111a797d6d662a64a6a74d305a46861d301655e115aa6c

- Consumidor 2:
Address:     0xa34dC89a6042bc02aB77b5a39bB081C361A91198
Private key: 0xdd52268b6c2620a68eb425b0caf375988e0e059e344772fea293512b78a9e888


**Cuentas para pruebas SERGI**

Available Accounts
==================

(0) 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000.000000000000000000 ETH)
(1) 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (10000.000000000000000000 ETH)
(2) 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC (10000.000000000000000000 ETH)
(3) 0x90F79bf6EB2c4f870365E785982E1f101E93b906 (10000.000000000000000000 ETH)
(4) 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65 (10000.000000000000000000 ETH)
(5) 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc (10000.000000000000000000 ETH)
(6) 0x976EA74026E726554dB657fA54763abd0C3a0aa9 (10000.000000000000000000 ETH)
(7) 0x14dC79964da2C08b23698B3D3cc7Ca32193d9955 (10000.000000000000000000 ETH)
(8) 0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f (10000.000000000000000000 ETH)
(9) 0xa0Ee7A142d267C1f36714E4a8F75612F20a79720 (10000.000000000000000000 ETH)

Private Keys
==================

(0) 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --Admin
(1) 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d -- Productor 1
(2) 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a -- Productor 2
(3) 0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6 -- Fabrica 1
(4) 0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a -- Fabrica 2
(5) 0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
(6) 0x92db14e403b83dfe3df233f83dfa3a0d7096f21ca9b0d6d6b8d88b2b4ec1564e
(7) 0x4bbbf85ce3377467afe5d46f804f221813b2bb87f24d81f60f1fcdbf7cbf4356
(8) 0xdbda1821b80551c9d65939329250298aa3472ba22feea921c0cf5d620ea67b97
(9) 0x2a871d0798f97d79848a013d4936a73bf4cc922c825d33c1cf7073dff6d409c6

Network Name: Anvil Local
RPC URL: http://127.0.0.1:8545
Chain ID: 31337
Currency Symbol: ETH

Wallet
==================
Mnemonic:          test test test test test test test test test test test junk
Derivation path:   m/44'/60'/0'/0/

## IMPORTANT FOR PRESENTATION
We can´t have camera on zoom and on the platform at the same time.

## INSTRUCCIONES PARA INSTALAR EL PROYECTO

## Prerequisites
- Foundry (Forge, Cast, Anvil)
- Node.js (v16 or higher)
- Git
- VS Code with Draw.io extension
```bash
code --install-extension hediet.vscode-drawio
```
Este último, opcional para vel el esquema en diagrams
--------------------------------------------------------------------------------------------------------------

npm install
CD smart_contracts
forge install
anvil

Nos dara 10 cuentas, con sus llaves privadas y direcciones.
Cojemos la primera que será la Admin

forge script script/Usuarios.s.sol:UsuariosDeploy --rpc-url http://127.0.0.1:8545 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

forge script script/Tokens.s.sol:TokensDeploy --rpc-url http://127.0.0.1:8545 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

forge script script/Certificate.s.sol:CertificateDeploy --rpc-url http://127.0.0.1:8545 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80



RPC para metamask:

Network Name: Anvil Local
RPC URL: http://127.0.0.1:8545
Chain ID: 31337
Currency Symbol: ETH


Una vez deployado el contrato, ponemos los datos del ABI y la dirección del contrato en -> /src/constants/contracts.ts


ATENCIÓN:

Si habésis deployado un contrato viejo, haced:

forge clean
forge build

y ya finalmente forge script



# Trazabilidad de Aceite - Blockchain dApp

## Descripción del Proyecto
Esta aplicación descentralizada (dApp) permite la trazabilidad completa del aceite de oliva desde su producción hasta el consumidor final, utilizando tecnología blockchain para garantizar la autenticidad y transparencia de la información.

## Arquitectura del Sistema

### Contratos Inteligentes
El sistema utiliza dos contratos principales desplegados en la red Sepolia:

1. **Contrato de Usuarios (`Usuarios.sol`)**
   - Gestiona los roles y permisos de los usuarios (Productor, Fábrica, Minorista, Consumidor)
   - Almacena información de usuarios como nombre, dirección y ubicación GPS
   - Funciones principales:
     - `nuevoUsuario`: Registro de nuevos usuarios con roles específicos
     - `getUsuarios`: Obtención de la lista de usuarios registrados

2. **Contrato de Tokens (`Tokens.sol`)**
   - Gestiona los tokens que representan lotes de aceite
   - Implementa la trazabilidad y transferencias entre actores
   - Funciones principales:
     - Creación de tokens para lotes de aceite
     - Gestión de atributos y características del producto
     - Registro de transferencias y trazabilidad

### Interacción con la Blockchain

#### 1. Autenticación y Roles
- Integración con MetaMask para la autenticación de usuarios
- Verificación automática de roles mediante el contrato de Usuarios
- Sistema de redirección basado en roles a dashboards específicos

#### 2. Gestión de Productos
- **Productores**:
  - Creación de tokens para nuevos lotes de aceite
  - Registro de atributos como temperatura, calidad, etc.
  - Transferencia de lotes a fábricas

- **Fábricas**:
  - Recepción y procesamiento de lotes
  - Creación de nuevos tokens para productos procesados
  - Registro de materias primas utilizadas

- **Minoristas**:
  - Recepción de productos procesados
  - Gestión de inventario
  - Generación de códigos QR para productos

#### 3. Trazabilidad
- Sistema de seguimiento mediante códigos QR únicos
- Cada código QR contiene:
  - ID del token
  - ID de transferencia
  - Timestamp de la transacción
- Historial completo de transferencias y procesamiento
- Visualización de la cadena de custodia en mapa interactivo

#### 4. Verificación de Productos
- Escaneo de códigos QR para acceso a información del producto
- Visualización de:
  - Origen del producto
  - Ruta de procesamiento
  - Certificaciones y atributos
  - Timestamps de cada etapa

## Archivos de Interacción con Blockchain

### Componentes Principales

1. **`src/utils/`**
   - **blockchain.ts**: 
     - Funciones principales de interacción con la blockchain
     - `fetchProductData`: Obtiene datos de productos por ID
     - `getTokenTransfers`: Recupera el historial de transferencias
     - `getReadOnlyProvider`: Proporciona conexión de solo lectura
   - **metamask.ts**:
     - Funciones de interacción con MetaMask
     - Manejo de conexión y firmas
     - Gestión de cuentas de usuario

2. **`src/context/Web3Context.tsx`**
   - Gestión del estado de conexión con Web3
   - Manejo de autenticación con MetaMask
   - Verificación de roles de usuario
   - Hooks personalizados para acceso a blockchain

3. **`src/app/dashboard/[role]/components/`**
   - **ProductorDashboard.tsx**: 
     - Creación y gestión de tokens de aceite
     - Transferencia de lotes a fábricas
     - Interacción con contrato de Tokens
   - **FabricaDashboard.tsx**:
     - Procesamiento de lotes
     - Creación de nuevos tokens procesados
     - Registro de materias primas
   - **MinoristaDashboard.tsx**:
     - Gestión de inventario
     - Generación de códigos QR
     - Transferencias a consumidores

4. **`src/app/product/[id]/page.tsx`**
   - Visualización de información del producto
   - Conexión con contratos para obtener:
     - Datos del token
     - Historial de transferencias
     - Atributos y certificaciones
   - Integración con QR y mapas

5. **`src/components/shared/`**
   - **TransactionMapClient.tsx**: 
     - Visualización de rutas de productos
     - Integración con datos de blockchain para ubicaciones
   - **QRCode.tsx**:
     - Generación de códigos QR con datos de blockchain
     - Formato: TokenID-TransferID-Timestamp

### Archivos de Configuración y Utilidades

1. **`src/constants/contracts.ts`**
   - Direcciones de contratos desplegados
   - ABIs de contratos
   - Configuración de red Sepolia

2. **`src/utils/attributeLabels.ts`**
   - Etiquetas y formatos para atributos de tokens
   - Configuración de unidades y medidas
   - Formateo de datos para visualización

### Flujo de Interacción con Blockchain

1. **Autenticación**:
   - Web3Context gestiona la conexión inicial con MetaMask
   - Verificación de roles mediante contrato de Usuarios
   - Redirección a dashboard específico según rol

2. **Operaciones con Tokens**:
   - Productores crean tokens mediante ProductorDashboard
   - Fábricas procesan y crean nuevos tokens en FabricaDashboard
   - Minoristas gestionan transferencias en MinoristaDashboard

3. **Trazabilidad**:
   - Generación de códigos QR con datos de blockchain
   - Visualización de rutas en mapas interactivos
   - Consulta de historial completo de transferencias

## Tecnologías Utilizadas
- **Frontend**: Next.js, TailwindCSS
- **Blockchain**: Ethereum (Red Sepolia)
- **Contratos**: Solidity
- **Bibliotecas**: ethers.js para interacción con blockchain
- **Mapas**: Leaflet para visualización de rutas
- **QR**: QRCode.react para generación de códigos QR

## Despliegue
La aplicación está desplegada en Vercel y accesible en:
https://trazabilidad-aceite-pfm.vercel.app/
